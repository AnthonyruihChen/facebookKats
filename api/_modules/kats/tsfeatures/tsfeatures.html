
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <!--
    <link rel="alternate" type="application/rss+xml" href="/Kats/blog/rss.xml" title="Kats Blog RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="/Kats/blog/atom.xml" title="Kats Blog Atom Feed">
    -->
    <!--
    <link rel="preconnect" href="https://www.google-analytics.com">
    <script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-149862507-1","auto"),ga("send","pageview")</script>
    <script async src="https://www.google-analytics.com/analytics.js"></script>
    -->
    <!--
    <title data-react-helmet="true">Kats | Kats</title>
    <meta data-react-helmet="true" property="og:title" content="Kats | Kats">
    <meta data-react-helmet="true" name="description" content="One stop shop for time series analysis in Python">
    <meta data-react-helmet="true" property="og:description" content="One stop shop for time series analysis in Python">
    <meta data-react-helmet="true" property="og:url" content="https://facebookresearch.github.io/Kats/">
    -->
    <link data-react-helmet="true" rel="shortcut icon" href="/Kats/img/KatsHeroLogo.png">
    <!--
    <link data-react-helmet="true" rel="canonical" href="https://facebookresearch.github.io/Kats/">
    <link data-react-helmet="true" rel="alternate" href="https://facebookresearch.github.io/Kats/" hreflang="en">
    <link data-react-helmet="true" rel="alternate" href="https://facebookresearch.github.io/Kats/" hreflang="x-default">
    -->
    <link rel="stylesheet" href="/Kats/assets/css/styles.99fd060a.css">
    <!--
    <link rel="preload" href="/Kats/assets/js/runtime~main.9e005abd.js" as="script">
    <link rel="preload" href="/Kats/assets/js/main.6382ca5e.js" as="script">
    -->
    </head>


<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>kats.tsfeatures.tsfeatures &#8212; Kats 0.0.1 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css" />
    <link rel="stylesheet" type="text/css" href="../../../_static/custom.css" />
    <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <!--
    <link rel="alternate" type="application/rss+xml" href="/Kats/blog/rss.xml" title="Kats Blog RSS Feed">
    <link rel="alternate" type="application/atom+xml" href="/Kats/blog/atom.xml" title="Kats Blog Atom Feed">
    -->
    <!--
    <link rel="preconnect" href="https://www.google-analytics.com">
    <script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","UA-149862507-1","auto"),ga("send","pageview")</script>
    <script async src="https://www.google-analytics.com/analytics.js"></script>
    -->
    <!--
    <title data-react-helmet="true">Kats | Kats</title>
    <meta data-react-helmet="true" property="og:title" content="Kats | Kats">
    <meta data-react-helmet="true" name="description" content="One stop shop for time series analysis in Python">
    <meta data-react-helmet="true" property="og:description" content="One stop shop for time series analysis in Python">
    <meta data-react-helmet="true" property="og:url" content="https://facebookresearch.github.io/Kats/">
    -->
    <link data-react-helmet="true" rel="shortcut icon" href="/Kats/img/KatsHeroLogo.png">
    <!--
    <link data-react-helmet="true" rel="canonical" href="https://facebookresearch.github.io/Kats/">
    <link data-react-helmet="true" rel="alternate" href="https://facebookresearch.github.io/Kats/" hreflang="en">
    <link data-react-helmet="true" rel="alternate" href="https://facebookresearch.github.io/Kats/" hreflang="x-default">
    -->
    <link rel="stylesheet" href="/Kats/assets/css/styles.99fd060a.css">
    <!--
    <link rel="preload" href="/Kats/assets/js/runtime~main.9e005abd.js" as="script">
    <link rel="preload" href="/Kats/assets/js/main.6382ca5e.js" as="script">
    -->
    </head>

  </head><body>
  

    <div class="document">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script>
<!--<div id="__docusaurus">-->
<div id="docusaurus-base-url-issue-banner-container"></div>
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div>
<nav class="navbar navbar--fixed-top">
  <div class="navbar__inner">
      <div class="navbar__items">
          <button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0">
              <svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false">
                  <title>Menu</title>
                  <path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path>
              </svg>
          </button>
          <a class="navbar__brand" href="/Kats/">
              <img src="/Kats/img/KatsHeroLogo.png" alt="Project Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"/>
              <img src="/Kats/img/KatsHeroLogo.png" alt="Project Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"/>
              <strong class="navbar__title">Kats</strong>
          </a>
          <a href="https://facebookresearch.github.io/Kats/api/" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">API</a>
          <a href="https://github.com/facebookresearch/Kats/tree/master/tutorials" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Tutorials</a>
      </div>
      <!--
      <div class="navbar__items navbar__items--right">
          <a href="https://github.com/facebookresearch/kats" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Kats@GitHub</a>
          <div class="react-toggle displayOnlyInLargeViewport_GrZ2" role="button" tabindex="-1">
              <div class="react-toggle-track">
                  <div class="react-toggle-track-check">
                      <span class="toggle_71bT">ðŸŒœ</span>
                  </div>
                  <div class="react-toggle-track-x">
                      <span class="toggle_71bT">ðŸŒž</span>
                  </div>
              </div>
              <div class="react-toggle-thumb"></div>
              <input type="checkbox" class="react-toggle-screenreader-only" aria-label="Switch between dark and light mode"/>
          </div>
      </div>
      -->
  </div>
  <div role="presentation" class="navbar-sidebar__backdrop"></div>
  <div class="navbar-sidebar">
      <div class="navbar-sidebar__brand">
          <a class="navbar__brand" href="/Kats/">
              <img src="/Kats/img/KatsHeroLogo.png" alt="Project Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"/>
              <img src="/Kats/img/KatsHeroLogo.png" alt="Project Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"/>
              <strong class="navbar__title">Kats</strong>
          </a>
      </div>
      <div class="navbar-sidebar__items">
          <div class="menu">
              <ul class="menu__list">
                  <li class="menu__list-item">
                      <a href="https://facebookresearch.github.io/Kats/api/" target="_blank" rel="noopener noreferrer" class="menu__link">API</a>
                  </li>
                  <li class="menu__list-item">
                      <a href="https://github.com/facebookresearch/Kats/tree/master/tutorials" target="_blank" rel="noopener noreferrer" class="menu__link">Tutorials</a>
                  </li>
                  <li class="menu__list-item">
                      <a href="https://github.com/facebookresearch/kats" target="_blank" rel="noopener noreferrer" class="menu__link">Kats@GitHub</a>
                  </li>
              </ul>
          </div>
      </div>
  </div>
</nav>
<div class="main-wrapper">
  
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for kats.tsfeatures.tsfeatures</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python3</span>

<span class="c1"># Copyright (c) Facebook, Inc. and its affiliates.</span>
<span class="c1"># This source code is licensed under the MIT license found in the</span>
<span class="c1"># LICENSE file in the root directory of this source tree.</span>

<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">statsmodels</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">partial</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">groupby</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span><span class="p">,</span> <span class="n">Dict</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>
<span class="kn">from</span> <span class="nn">kats.consts</span> <span class="kn">import</span> <span class="n">TimeSeriesData</span>
<span class="kn">from</span> <span class="nn">kats.detectors</span> <span class="kn">import</span> <span class="p">(</span>
    <span class="n">cusum_detection</span><span class="p">,</span>
    <span class="n">bocpd</span><span class="p">,</span>
    <span class="n">robust_stat_detection</span><span class="p">,</span>
    <span class="n">outlier</span><span class="p">,</span>
    <span class="n">trend_mk</span><span class="p">,</span>
    <span class="n">seasonality</span><span class="p">,</span>
<span class="p">)</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span>  <span class="c1"># @manual</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">periodogram</span>  <span class="c1"># @manual</span>
<span class="kn">from</span> <span class="nn">statsmodels.stats.diagnostic</span> <span class="kn">import</span> <span class="n">het_arch</span>
<span class="kn">from</span> <span class="nn">statsmodels.tsa.holtwinters</span> <span class="kn">import</span> <span class="n">ExponentialSmoothing</span>
<span class="kn">from</span> <span class="nn">statsmodels.tsa.seasonal</span> <span class="kn">import</span> <span class="n">STL</span>
<span class="kn">from</span> <span class="nn">statsmodels.tsa.stattools</span> <span class="kn">import</span> <span class="n">acf</span><span class="p">,</span> <span class="n">pacf</span><span class="p">,</span> <span class="n">kpss</span>

<span class="sd">&quot;&quot;&quot;TsFeatures is a module for performing adhoc feature engineering on time series</span>
<span class="sd">data using different statistics.</span>

<span class="sd">The module process time series data into features for machine learning models.</span>
<span class="sd">We include seasonality, autocorrelation, modeling parameter, changepoints,</span>
<span class="sd">moving statistics, and raw statistics of time series array as the adhoc features.</span>

<span class="sd">We also offer to compute part of the features or group of features using</span>
<span class="sd">selected_features argument, you could also disable feature or group of</span>
<span class="sd">features by setting feature_name/feature_group_name = False. You can find</span>
<span class="sd">all feature group names in feature_group_mapping attribute.</span>
<span class="sd">&quot;&quot;&quot;</span>


<div class="viewcode-block" id="TsFeatures"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures">[docs]</a><span class="k">class</span> <span class="nc">TsFeatures</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Process time series data into features for machine learning models, with the</span>
<span class="sd">    function to opt-in/out feature and feature groups in the calculations.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        window_size: int; Length of the sliding window for getting level shift features,</span>
<span class="sd">            lumpiness, and stability of time series.</span>
<span class="sd">        spectral_freq: int; Frequency parameter in getting periodogram through scipy for</span>
<span class="sd">            calculating Shannon entropy.</span>
<span class="sd">        stl_period: int; Period parameter for performing seasonality trend decomposition</span>
<span class="sd">            using LOESS with statsmodels.</span>
<span class="sd">        nbins: int; Number of bins to equally segment time series array for getting flat</span>
<span class="sd">            spot feature.</span>
<span class="sd">        lag_size: int; Maximum number of lag values for calculating Hurst Exponent.</span>
<span class="sd">        acfpacf_lag: int; Largest lag number for returning ACF/PACF features via statsmodels.</span>
<span class="sd">        decomp: str; Additive or Multiplicative mode for performing outlier detection using</span>
<span class="sd">            Kats.Detectors.outlier.OutlierDetector.</span>
<span class="sd">        iqr_mult: float; IQR range for determining outliers through</span>
<span class="sd">            Kats.Detectors.outlier.OutlierDetector.</span>
<span class="sd">        threshold: float; threshold for trend intensity; higher threshold gives</span>
<span class="sd">            trend with high intensity (0.8 by default).  If we only want to use the</span>
<span class="sd">            p-value to determine changepoints, set threshold = 0.</span>
<span class="sd">        window: int; length of window for all nowcasting features.</span>
<span class="sd">        n_fast: int; length of &quot;fast&quot; or short period exponential moving average in the MACD</span>
<span class="sd">            algorithm in the nowcasting features.</span>
<span class="sd">        n_slow: int; length of &quot;slow&quot; or long period exponential moving average in the MACD</span>
<span class="sd">            algorithm in the nowcasting features.</span>
<span class="sd">        selected_features: None or List[str]; list of feature/feature group name(s)</span>
<span class="sd">            selected to be calculated. We will try only calculating selected</span>
<span class="sd">            features, since some features are bundled in the calculations. This process</span>
<span class="sd">            helps with boosting efficiency, and we will only output selected features.</span>
<span class="sd">        feature_group_mapping: The dictionary with the mapping from individual features</span>
<span class="sd">            to their bundled feature groups.</span>
<span class="sd">        final_filter: A dicitonary with boolean as the values to filter out the features</span>
<span class="sd">            not selected, yet calculated due to underlying bundles.</span>
<span class="sd">        stl_features: Switch for calculating/outputting stl features.</span>
<span class="sd">        level_shift_features: Switch for calculating/outputting level shift features.</span>
<span class="sd">        acfpacf_features: Switch for calculating/outputting ACF/PACF features.</span>
<span class="sd">        special_ac: Switch for calculating/outputting  features.</span>
<span class="sd">        holt_params: Switch for calculating/outputting holt parameter features.</span>
<span class="sd">        hw_params: Switch for calculating/outputting holt-winters parameter features.</span>
<span class="sd">        statistics: Switch for calculating/outputting raw statistics features.</span>
<span class="sd">        cusum_detector: Switch for calculating/outputting features using cusum detector</span>
<span class="sd">            in Kats.</span>
<span class="sd">        robust_stat_detector: Switch for calculating/outputting features using robust stat detector</span>
<span class="sd">            in Kats.</span>
<span class="sd">        bocp_detector: Switch for calculating/outputting stl features features using bocp detector</span>
<span class="sd">            in Kats.</span>
<span class="sd">        outlier_detector: Switch for calculating/outputting stl features using outlier detector</span>
<span class="sd">            in Kats.</span>
<span class="sd">        trend_detector: Switch for calculating/outputting stl features using trend detector</span>
<span class="sd">            in Kats.</span>
<span class="sd">        nowcasting: Switch for calculating/outputting stl features using nowcasting detector</span>
<span class="sd">            in Kats.</span>
<span class="sd">        seasonalities: Switch for calculating/outputting stl features using cusum detector</span>
<span class="sd">            in Kats.</span>
<span class="sd">        default: The default status of the switch for opt-in/out feature calculations.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">window_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">spectral_freq</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">stl_period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
        <span class="n">nbins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span>
        <span class="n">lag_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">,</span>
        <span class="n">acfpacf_lag</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
        <span class="n">decomp</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;additive&quot;</span><span class="p">,</span>
        <span class="n">iqr_mult</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">n_fast</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">n_slow</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">21</span><span class="p">,</span>
        <span class="n">selected_features</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="o">**</span><span class="n">kwargs</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="c1"># init hyper-parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window_size</span> <span class="o">=</span> <span class="n">window_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">spectral_freq</span> <span class="o">=</span> <span class="n">spectral_freq</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stl_period</span> <span class="o">=</span> <span class="n">stl_period</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nbins</span> <span class="o">=</span> <span class="n">nbins</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lag_size</span> <span class="o">=</span> <span class="n">lag_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acfpacf_lag</span> <span class="o">=</span> <span class="n">acfpacf_lag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">decomp</span> <span class="o">=</span> <span class="n">decomp</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">iqr_mult</span> <span class="o">=</span> <span class="n">iqr_mult</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">window</span> <span class="o">=</span> <span class="n">window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_fast</span> <span class="o">=</span> <span class="n">n_fast</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_slow</span> <span class="o">=</span> <span class="n">n_slow</span>

        <span class="c1"># Mapping group features</span>
        <span class="n">g2f</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;stl_features&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;trend_strength&quot;</span><span class="p">,</span>
                <span class="s2">&quot;seasonality_strength&quot;</span><span class="p">,</span>
                <span class="s2">&quot;spikiness&quot;</span><span class="p">,</span>
                <span class="s2">&quot;peak&quot;</span><span class="p">,</span>
                <span class="s2">&quot;trough&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;level_shift_features&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;level_shift_idx&quot;</span><span class="p">,</span>
                <span class="s2">&quot;level_shift_size&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;acfpacf_features&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;y_acf1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y_acf5&quot;</span><span class="p">,</span>
                <span class="s2">&quot;diff1y_acf1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;diff1y_acf5&quot;</span><span class="p">,</span>
                <span class="s2">&quot;diff2y_acf1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;diff2y_acf5&quot;</span><span class="p">,</span>
                <span class="s2">&quot;y_pacf5&quot;</span><span class="p">,</span>
                <span class="s2">&quot;diff1y_pacf5&quot;</span><span class="p">,</span>
                <span class="s2">&quot;diff2y_pacf5&quot;</span><span class="p">,</span>
                <span class="s2">&quot;seas_acf1&quot;</span><span class="p">,</span>
                <span class="s2">&quot;seas_pacf1&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;special_ac&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;firstmin_ac&quot;</span><span class="p">,</span>
                <span class="s2">&quot;firstzero_ac&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;holt_params&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;holt_alpha&quot;</span><span class="p">,</span>
                <span class="s2">&quot;holt_beta&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;hw_params&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;hw_alpha&quot;</span><span class="p">,</span>
                <span class="s2">&quot;hw_beta&quot;</span><span class="p">,</span>
                <span class="s2">&quot;hw_gamma&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;statistics&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;length&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mean&quot;</span><span class="p">,</span>
                <span class="s2">&quot;var&quot;</span><span class="p">,</span>
                <span class="s2">&quot;entropy&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lumpiness&quot;</span><span class="p">,</span>
                <span class="s2">&quot;stability&quot;</span><span class="p">,</span>
                <span class="s2">&quot;flat_spots&quot;</span><span class="p">,</span>
                <span class="s2">&quot;hurst&quot;</span><span class="p">,</span>
                <span class="s2">&quot;std1st_der&quot;</span><span class="p">,</span>
                <span class="s2">&quot;crossing_points&quot;</span><span class="p">,</span>
                <span class="s2">&quot;binarize_mean&quot;</span><span class="p">,</span>
                <span class="s2">&quot;unitroot_kpss&quot;</span><span class="p">,</span>
                <span class="s2">&quot;heterogeneity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;histogram_mode&quot;</span><span class="p">,</span>
                <span class="s2">&quot;linearity&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;cusum_detector&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;cusum_num&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cusum_conf&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cusum_cp_index&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cusum_delta&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cusum_llr&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cusum_regression_detected&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cusum_stable_changepoint&quot;</span><span class="p">,</span>
                <span class="s2">&quot;cusum_p_value&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;robust_stat_detector&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;robust_num&quot;</span><span class="p">,</span>
                <span class="s2">&quot;robust_metric_mean&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;bocp_detector&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;bocp_num&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bocp_conf_max&quot;</span><span class="p">,</span>
                <span class="s2">&quot;bocp_conf_mean&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;outlier_detector&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;outlier_num&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;trend_detector&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;trend_num&quot;</span><span class="p">,</span>
                <span class="s2">&quot;trend_num_increasing&quot;</span><span class="p">,</span>
                <span class="s2">&quot;trend_avg_abs_tau&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;nowcasting&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;nowcast_roc&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nowcast_ma&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nowcast_mom&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nowcast_lag&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nowcast_macd&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nowcast_macdsign&quot;</span><span class="p">,</span>
                <span class="s2">&quot;nowcast_macddiff&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="s2">&quot;seasonalities&quot;</span><span class="p">:</span> <span class="p">[</span>
                <span class="s2">&quot;seasonal_period&quot;</span><span class="p">,</span>
                <span class="s2">&quot;trend_mag&quot;</span><span class="p">,</span>
                <span class="s2">&quot;seasonality_mag&quot;</span><span class="p">,</span>
                <span class="s2">&quot;residual_std&quot;</span><span class="p">,</span>
            <span class="p">],</span>
        <span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">feature_group_mapping</span> <span class="o">=</span> <span class="n">g2f</span>
        <span class="n">f2g</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">g2f</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">f2g</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_total_feature_len_</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">f2g</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">assert</span> <span class="p">(</span>
                <span class="n">f</span> <span class="ow">in</span> <span class="n">f2g</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">g2f</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
            <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;couldn&#39;t find your desired feature/group &quot;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;, please check spelling&quot;&quot;&quot;</span>

        <span class="c1"># Higher level of features:</span>
        <span class="c1"># Once disabled, won&#39;t even go inside these groups of features</span>
        <span class="c1"># for calculation</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">selected_features</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_filter</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">default</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">f2g</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="k">elif</span> <span class="n">selected_features</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_filter</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">default</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">f2g</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">selected_features</span><span class="p">:</span>
                <span class="k">assert</span> <span class="p">(</span>
                    <span class="n">f</span> <span class="ow">in</span> <span class="n">f2g</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span> <span class="ow">or</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">g2f</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;couldn&#39;t find your desired feature/group &quot;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;, please check spelling&quot;&quot;&quot;</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">g2f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># the opt-in request is for a feature group</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">g2f</span><span class="p">[</span><span class="n">f</span><span class="p">]:</span>
                        <span class="n">kwargs</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">final_filter</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">elif</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">f2g</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>  <span class="c1"># the opt-in request is for a certain feature</span>
                    <span class="k">assert</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">f2g</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="kc">True</span>
                    <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;feature group: </span><span class="si">{</span><span class="n">f2g</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="si">}</span><span class="s2"> has to be opt-in based on your opt-in request of feature: </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
                    <span class="k">assert</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
                        <span class="n">f</span><span class="p">,</span> <span class="kc">True</span>
                    <span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;you have requested to both opt-in and opt-out feature: </span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&quot;&quot;&quot;</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="n">f2g</span><span class="p">[</span><span class="n">f</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># need to opt-in the feature group first</span>
                    <span class="n">kwargs</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># opt-in the feature</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">final_filter</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">final_filter</span><span class="p">[</span>
                <span class="n">k</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">v</span>  <span class="c1"># final filter for filtering out features user didn&#39;t request and keep only the requested ones</span>

        <span class="c1"># setting default value for the switches of calculating the group of features or not</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stl_features</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;stl_features&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">level_shift_features</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;level_shift_features&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">acfpacf_features</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;acfpacf_features&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">special_ac</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;special_ac&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">holt_params</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;holt_params&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hw_params</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hw_params&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">statistics</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;statistics&quot;</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cusum_detector</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cusum_detector&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">robust_stat_detector</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;robust_stat_detector&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bocp_detector</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bocp_detector&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outlier_detector</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;outlier_detector&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trend_detector</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;trend_detector&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nowcasting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nowcasting&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">seasonalities</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;seasonalities&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

        <span class="c1"># For lower level of the features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">__kwargs__</span> <span class="o">=</span> <span class="n">kwargs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">default</span> <span class="o">=</span> <span class="n">default</span>

<div class="viewcode-block" id="TsFeatures.transform"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">TimeSeriesData</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        The overall high-level function for transforming</span>
<span class="sd">        time series into a number of features</span>

<span class="sd">        Args:</span>
<span class="sd">            x: Kats TimeSeriesData object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Returning maps (dictionary) with feature name and value pair.</span>
<span class="sd">            For univariate input return a map of {feature: value}.</span>
<span class="sd">            For multivarite input return a list of maps.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">5</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Length of time series is too short to calculate features!&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">!=</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;expecting values to be a np.ndarray, instead got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="c1"># make sure that values are numpy array for feeding to Numba</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)}</span>
            <span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">TimeSeriesData</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># a single Series: return a map of {feature: value}</span>
            <span class="n">ts_values</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">values</span>
            <span class="n">ts_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_transform_1d</span><span class="p">(</span><span class="n">ts_values</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># multiple time series: return a list of map {feature: value}</span>
            <span class="n">ts_features</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">ts_values</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>  <span class="c1"># extract 1-d numpy array</span>
                <span class="n">ts_features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_transform_1d</span><span class="p">(</span><span class="n">ts_values</span><span class="p">,</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">[</span><span class="n">col</span><span class="p">]))</span>

        <span class="c1"># performing final filter</span>
        <span class="n">to_remove</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">ts_features</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">final_filter</span><span class="p">[</span><span class="n">feature</span><span class="p">]:</span>
                <span class="n">to_remove</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">to_remove</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">ts_features</span><span class="p">[</span><span class="n">r</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">ts_features</span></div>

    <span class="k">def</span> <span class="nf">_transform_1d</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ts</span><span class="p">:</span> <span class="n">TimeSeriesData</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform single (univariate) time series</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>
<span class="sd">            ts: The univariate time series array in the form of Kats Timeseries</span>
<span class="sd">                Data object.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The dictionary with all the features aggregated from the outputs of</span>
<span class="sd">            each feature group calculator.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># calculate STL based features</span>
        <span class="n">dict_stl_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">stl_features</span><span class="p">:</span>
            <span class="n">dict_stl_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_stl_features</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stl_period</span><span class="p">,</span>
                <span class="n">extra_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__kwargs__</span><span class="p">,</span>
                <span class="n">default_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># calculate level shift based features</span>
        <span class="n">dict_level_shift_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">level_shift_features</span><span class="p">:</span>
            <span class="n">dict_level_shift_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_level_shift</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">window_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">,</span>
                <span class="n">extra_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__kwargs__</span><span class="p">,</span>
                <span class="n">default_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># calculate ACF, PACF based features</span>
        <span class="n">dict_acfpacf_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">acfpacf_features</span><span class="p">:</span>
            <span class="n">dict_acfpacf_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_acfpacf_features</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">acfpacf_lag</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">acfpacf_lag</span><span class="p">,</span>
                <span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stl_period</span><span class="p">,</span>
                <span class="n">extra_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__kwargs__</span><span class="p">,</span>
                <span class="n">default_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># calculate special AC</span>
        <span class="n">dict_specialac_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">special_ac</span><span class="p">:</span>
            <span class="n">dict_specialac_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_special_ac</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__kwargs__</span><span class="p">,</span> <span class="n">default_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span>
            <span class="p">)</span>

        <span class="c1"># calculate holt params</span>
        <span class="n">dict_holt_params_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">holt_params</span><span class="p">:</span>
            <span class="n">dict_holt_params_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_holt_params</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__kwargs__</span><span class="p">,</span> <span class="n">default_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span>
            <span class="p">)</span>

        <span class="c1"># calculate hw params</span>
        <span class="n">dict_hw_params_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">hw_params</span><span class="p">:</span>
            <span class="n">dict_hw_params_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_hw_params</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">period</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">stl_period</span><span class="p">,</span>
                <span class="n">extra_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__kwargs__</span><span class="p">,</span>
                <span class="n">default_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># single features</span>
        <span class="n">_dict_features_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">statistics</span><span class="p">:</span>
            <span class="n">dict_features</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;length&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_length</span><span class="p">),</span>
                <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_mean</span><span class="p">),</span>
                <span class="s2">&quot;var&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_var</span><span class="p">),</span>
                <span class="s2">&quot;entropy&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_spectral_entropy</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">spectral_freq</span><span class="p">),</span>
                <span class="s2">&quot;lumpiness&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_lumpiness</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">),</span>
                <span class="s2">&quot;stability&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_stability</span><span class="p">,</span> <span class="n">window_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window_size</span><span class="p">),</span>
                <span class="s2">&quot;flat_spots&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_flat_spots</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">),</span>
                <span class="s2">&quot;hurst&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_hurst</span><span class="p">,</span> <span class="n">lag_size</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">lag_size</span><span class="p">),</span>
                <span class="s2">&quot;std1st_der&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_std1st_der</span><span class="p">),</span>
                <span class="s2">&quot;crossing_points&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_crossing_points</span><span class="p">),</span>
                <span class="s2">&quot;binarize_mean&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_binarize_mean</span><span class="p">),</span>
                <span class="s2">&quot;unitroot_kpss&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_unitroot_kpss</span><span class="p">),</span>
                <span class="s2">&quot;heterogeneity&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_het_arch</span><span class="p">),</span>
                <span class="s2">&quot;histogram_mode&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_histogram_mode</span><span class="p">,</span> <span class="n">nbins</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">nbins</span><span class="p">),</span>
                <span class="s2">&quot;linearity&quot;</span><span class="p">:</span> <span class="n">partial</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_linearity</span><span class="p">),</span>
            <span class="p">}</span>

            <span class="n">_dict_features_</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">dict_features</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">__kwargs__</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">):</span>
                    <span class="n">_dict_features_</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># calculate cusum detector features</span>
        <span class="n">dict_cusum_detector_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cusum_detector</span><span class="p">:</span>
            <span class="n">dict_cusum_detector_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_cusum_detector</span><span class="p">(</span>
                <span class="n">ts</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__kwargs__</span><span class="p">,</span> <span class="n">default_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span>
            <span class="p">)</span>

        <span class="c1"># calculate robust stat detector features</span>
        <span class="n">dict_robust_stat_detector_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">robust_stat_detector</span><span class="p">:</span>
            <span class="n">dict_robust_stat_detector_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_robust_stat_detector</span><span class="p">(</span>
                <span class="n">ts</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__kwargs__</span><span class="p">,</span> <span class="n">default_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span>
            <span class="p">)</span>

        <span class="c1"># calculate bocp detector features</span>
        <span class="n">dict_bocp_detector_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">bocp_detector</span><span class="p">:</span>
            <span class="n">dict_bocp_detector_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bocp_detector</span><span class="p">(</span>
                <span class="n">ts</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__kwargs__</span><span class="p">,</span> <span class="n">default_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span>
            <span class="p">)</span>

        <span class="c1"># calculate outlier detector features</span>
        <span class="n">dict_outlier_detector_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">outlier_detector</span><span class="p">:</span>
            <span class="n">dict_outlier_detector_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_outlier_detector</span><span class="p">(</span>
                <span class="n">ts</span><span class="p">,</span>
                <span class="n">decomp</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">decomp</span><span class="p">,</span>
                <span class="n">iqr_mult</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">iqr_mult</span><span class="p">,</span>
                <span class="n">extra_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__kwargs__</span><span class="p">,</span>
                <span class="n">default_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># calculate trend detector features</span>
        <span class="n">dict_trend_detector_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">trend_detector</span><span class="p">:</span>
            <span class="n">dict_trend_detector_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_trend_detector</span><span class="p">(</span>
                <span class="n">ts</span><span class="p">,</span>
                <span class="n">threshold</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">,</span>
                <span class="n">extra_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__kwargs__</span><span class="p">,</span>
                <span class="n">default_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># calculate nowcasting features</span>
        <span class="n">dict_nowcasting_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nowcasting</span><span class="p">:</span>
            <span class="n">dict_nowcasting_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_nowcasting</span><span class="p">(</span>
                <span class="n">x</span><span class="p">,</span>
                <span class="n">window</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">window</span><span class="p">,</span>
                <span class="n">n_fast</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_fast</span><span class="p">,</span>
                <span class="n">n_slow</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_slow</span><span class="p">,</span>
                <span class="n">extra_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__kwargs__</span><span class="p">,</span>
                <span class="n">default_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># calculate seasonality features</span>
        <span class="n">dict_seasonality_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">seasonalities</span><span class="p">:</span>
            <span class="n">dict_seasonality_features</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_seasonalities</span><span class="p">(</span>
                <span class="n">ts</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">__kwargs__</span><span class="p">,</span> <span class="n">default_status</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">default</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="p">{</span>
            <span class="o">**</span><span class="n">_dict_features_</span><span class="p">,</span>
            <span class="o">**</span><span class="n">dict_stl_features</span><span class="p">,</span>
            <span class="o">**</span><span class="n">dict_level_shift_features</span><span class="p">,</span>
            <span class="o">**</span><span class="n">dict_acfpacf_features</span><span class="p">,</span>
            <span class="o">**</span><span class="n">dict_specialac_features</span><span class="p">,</span>
            <span class="o">**</span><span class="n">dict_holt_params_features</span><span class="p">,</span>
            <span class="o">**</span><span class="n">dict_hw_params_features</span><span class="p">,</span>
            <span class="o">**</span><span class="n">dict_cusum_detector_features</span><span class="p">,</span>
            <span class="o">**</span><span class="n">dict_robust_stat_detector_features</span><span class="p">,</span>
            <span class="o">**</span><span class="n">dict_bocp_detector_features</span><span class="p">,</span>
            <span class="o">**</span><span class="n">dict_outlier_detector_features</span><span class="p">,</span>
            <span class="o">**</span><span class="n">dict_trend_detector_features</span><span class="p">,</span>
            <span class="o">**</span><span class="n">dict_nowcasting_features</span><span class="p">,</span>
            <span class="o">**</span><span class="n">dict_seasonality_features</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="c1"># length</span>
<div class="viewcode-block" id="TsFeatures.get_length"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_length">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_length</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Getting the length of time series array.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Length of the time series array.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>

    <span class="c1"># mean</span>
<div class="viewcode-block" id="TsFeatures.get_mean"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_mean">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_mean</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Getting the average value of time series array.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Average of the time series array.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>

    <span class="c1"># variance</span>
<div class="viewcode-block" id="TsFeatures.get_var"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_var">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_var</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Getting the variance of time series array.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Variance of the time series array.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x</span><span class="p">)</span></div>

    <span class="c1"># spectral entropy</span>
<div class="viewcode-block" id="TsFeatures.get_spectral_entropy"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_spectral_entropy">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">forceobj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_spectral_entropy</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">freq</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Getting normalized Shannon entropy of power spectral density.</span>
<span class="sd">        PSD is calculated using scipy&#39;s periodogram.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>
<span class="sd">            freq: int; Frequency for calculating the PSD via scipy periodogram.</span>
<span class="sd">                Default value is 1.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Normalized Shannon entropy.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># calculate periodogram</span>
        <span class="n">_</span><span class="p">,</span> <span class="n">psd</span> <span class="o">=</span> <span class="n">periodogram</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">freq</span><span class="p">)</span>

        <span class="c1"># calculate shannon entropy of normalized psd</span>
        <span class="n">psd_norm</span> <span class="o">=</span> <span class="n">psd</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">psd</span><span class="p">)</span>
        <span class="n">entropy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">psd_norm</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">psd_norm</span><span class="p">))</span>

        <span class="k">return</span> <span class="o">-</span><span class="p">(</span><span class="n">entropy</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">log2</span><span class="p">(</span><span class="n">psd_norm</span><span class="o">.</span><span class="n">size</span><span class="p">))</span></div>

    <span class="c1"># lumpiness</span>
<div class="viewcode-block" id="TsFeatures.get_lumpiness"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_lumpiness">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">forceobj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_lumpiness</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">window_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculating the lumpiness of time series.</span>
<span class="sd">        Lumpiness is defined as the variance of the chunk-wise variances.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>
<span class="sd">            window_size: int; Window size to split the data into chunks for getting</span>
<span class="sd">                variances. Default value is 20.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Lumpiness of the time series array.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">x_w</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_w</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="n">window_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></div>

    <span class="c1"># stability</span>
<div class="viewcode-block" id="TsFeatures.get_stability"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_stability">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">forceobj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_stability</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">window_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculating the stability of time series.</span>
<span class="sd">        Stability is defined as the variance of chunk-wise means.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>
<span class="sd">            window_size: int; Window size to split the data into chunks for getting</span>
<span class="sd">                variances. Default value is 20.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Stability of the time series array.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x_w</span><span class="p">)</span> <span class="k">for</span> <span class="n">x_w</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">array_split</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="n">window_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">v</span><span class="p">)</span></div>

    <span class="c1"># STL decomposition based features</span>
<div class="viewcode-block" id="TsFeatures.get_stl_features"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_stl_features">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">forceobj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_stl_features</span><span class="p">(</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
        <span class="n">extra_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate STL based features for a time series, including strength of</span>
<span class="sd">        trend, seasonality, spikiness, peak/trough.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>
<span class="sd">            period: int; Period parameter for performing seasonality trend decomposition</span>
<span class="sd">                using LOESS with statsmodels. Default value is 7.</span>
<span class="sd">            extra_args: A dictionary containing information for disabling calculation</span>
<span class="sd">                of a certain feature. Default value is None, i.e. no feature is disabled.</span>
<span class="sd">            default_status: Default status of the switch for calculate the features or not.</span>
<span class="sd">                Default value is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Seasonality features including strength of trend, seasonality, spikiness,</span>
<span class="sd">            peak/trough.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">stl_features</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># STL decomposition</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">STL</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">period</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

        <span class="c1"># strength of trend</span>
        <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;trend_strength&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">stl_features</span><span class="p">[</span><span class="s2">&quot;trend_strength&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span>
                <span class="n">res</span><span class="o">.</span><span class="n">trend</span> <span class="o">+</span> <span class="n">res</span><span class="o">.</span><span class="n">resid</span>
            <span class="p">)</span>

        <span class="c1"># strength of seasonality</span>
        <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;seasonality_strength&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">stl_features</span><span class="p">[</span><span class="s2">&quot;seasonality_strength&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span>
                <span class="n">res</span><span class="o">.</span><span class="n">seasonal</span> <span class="o">+</span> <span class="n">res</span><span class="o">.</span><span class="n">resid</span>
            <span class="p">)</span>

        <span class="c1"># spikiness: variance of the leave-one-out variances of the remainder component</span>
        <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;spikiness&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">resid_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">resid</span><span class="p">)[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">newaxis</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">resid</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
            <span class="p">)</span>
            <span class="n">resid_array</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">diag_indices</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resid_array</span><span class="p">))]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>
            <span class="n">stl_features</span><span class="p">[</span><span class="s2">&quot;spikiness&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanvar</span><span class="p">(</span><span class="n">resid_array</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="c1"># location of peak</span>
        <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;peak&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">stl_features</span><span class="p">[</span><span class="s2">&quot;peak&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">seasonal</span><span class="p">[:</span><span class="n">period</span><span class="p">])</span>

        <span class="c1"># location of trough</span>
        <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;trough&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">stl_features</span><span class="p">[</span><span class="s2">&quot;trough&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">seasonal</span><span class="p">[:</span><span class="n">period</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">stl_features</span></div>

    <span class="c1"># Level shift</span>
<div class="viewcode-block" id="TsFeatures.get_level_shift"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_level_shift">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">forceobj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_level_shift</span><span class="p">(</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">window_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>
        <span class="n">extra_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">:</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculating level shift features.</span>

<span class="sd">        * level_shift_idx: Location of the maximum mean value difference,</span>
<span class="sd">          between two consecutive sliding windows</span>
<span class="sd">        * level_shift_size: Size of the maximum mean value difference,</span>
<span class="sd">          between two consecutive sliding windows</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>
<span class="sd">            window_size: int; Length of the sliding window. Default value is 20.</span>
<span class="sd">            extra_args: A dictionary containing information for disabling calculation</span>
<span class="sd">                of a certain feature. Default value is None, i.e. no feature is disabled.</span>
<span class="sd">            default_status: Default status of the switch for calculate the features or not.</span>
<span class="sd">                Default value is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Level shift features including level_shift_idx, and level_shift_size</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">level_shift_features</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;level_shift_idx&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;level_shift_size&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">window_size</span> <span class="o">+</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Length of time series is shorter than window_size, unable to calculate level shift features!&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">level_shift_features</span>

        <span class="n">sliding_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">window_size</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">])[</span>
            <span class="p">:,</span> <span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="n">window_size</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="p">]</span>
        <span class="n">means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">sliding_idx</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">mean_diff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">means</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">means</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

        <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;level_shift_idx&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">level_shift_features</span><span class="p">[</span><span class="s2">&quot;level_shift_idx&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">mean_diff</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;level_shift_size&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">level_shift_features</span><span class="p">[</span><span class="s2">&quot;level_shift_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">mean_diff</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">mean_diff</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">level_shift_features</span></div>

    <span class="c1"># Flat spots</span>
<div class="viewcode-block" id="TsFeatures.get_flat_spots"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_flat_spots">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">forceobj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_flat_spots</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">nbins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Getting flat spots: Maximum run-lengths across equally-sized segments of time series</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>
<span class="sd">            nbins: int; Number of bins to segment time series data into.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Maximum run-lengths across segmented time series array.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">nbins</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Length of time series is shorter than nbins, unable to calculate flat spots feature!&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">max_run_length</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">window_size</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">/</span> <span class="n">nbins</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">window_size</span><span class="p">):</span>
            <span class="n">run_length</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span>
                <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">window_size</span><span class="p">])]</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">run_length</span> <span class="o">&gt;</span> <span class="n">max_run_length</span><span class="p">:</span>
                <span class="n">max_run_length</span> <span class="o">=</span> <span class="n">run_length</span>
        <span class="k">return</span> <span class="n">max_run_length</span></div>

    <span class="c1"># Hurst Exponent</span>
<div class="viewcode-block" id="TsFeatures.get_hurst"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_hurst">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">forceobj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_hurst</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">lag_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">30</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Getting: Hurst Exponent wiki: https://en.wikipedia.org/wiki/Hurst_exponent</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>
<span class="sd">            lag_size: int; Size for getting lagged time series data. Default value</span>
<span class="sd">                is 30.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The Hurst Exponent of the time series array</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Create the range of lag values</span>
        <span class="n">lags</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">lag_size</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span>

        <span class="c1"># Calculate the array of the variances of the lagged differences</span>
        <span class="n">tau</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)[</span><span class="n">lag</span><span class="p">:]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)[:</span><span class="o">-</span><span class="n">lag</span><span class="p">])</span> <span class="k">for</span> <span class="n">lag</span> <span class="ow">in</span> <span class="n">lags</span><span class="p">]</span>

        <span class="c1"># Use a linear fit to estimate the Hurst Exponent</span>
        <span class="n">poly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">lags</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">tau</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Return the Hurst exponent from the polyfit output</span>
        <span class="k">return</span> <span class="n">poly</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">poly</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="k">else</span> <span class="mi">0</span></div>

    <span class="c1"># ACF and PACF features</span>
    <span class="c1"># ACF features</span>
<div class="viewcode-block" id="TsFeatures.get_acf_features"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_acf_features">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">forceobj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_acf_features</span><span class="p">(</span>
        <span class="n">extra_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">default_status</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">y_acf_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">diff1y_acf_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">diff2y_acf_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aggregating extracted ACF features from get_acfpacf_features function.</span>

<span class="sd">        Args:</span>
<span class="sd">            extra_args: A dictionary containing information for disabling calculation</span>
<span class="sd">                of a certain feature. Default value is None, i.e. no feature is disabled.</span>
<span class="sd">            default_status: Default status of the switch for calculate the features or not.</span>
<span class="sd">                Default value is True.</span>
<span class="sd">            y_acf_list: List of ACF values acquired from original time series.</span>
<span class="sd">            diff1y_acf_list: List of ACF values acquired from differenced time series.</span>
<span class="sd">            diff2y_acf_list: List of ACF values acquired from twice differenced time series.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Auto-correlation function (ACF) features.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="p">(</span>
            <span class="n">y_acf1</span><span class="p">,</span>
            <span class="n">y_acf5</span><span class="p">,</span>
            <span class="n">diff1y_acf1</span><span class="p">,</span>
            <span class="n">diff1y_acf5</span><span class="p">,</span>
            <span class="n">diff2y_acf1</span><span class="p">,</span>
            <span class="n">diff2y_acf5</span><span class="p">,</span>
            <span class="n">seas_acf1</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># y_acf1: first ACF value of the original series</span>
        <span class="k">if</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_acf1&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">y_acf1</span> <span class="o">=</span> <span class="n">y_acf_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># y_acf5: sum of squares of first 5 ACF values of original series</span>
        <span class="k">if</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_acf5&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">y_acf5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_acf_list</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># diff1y_acf1: first ACF value of the differenced series</span>
        <span class="k">if</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;diff1y_acf1&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">diff1y_acf1</span> <span class="o">=</span> <span class="n">diff1y_acf_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># diff1y_acf5: sum of squares of first 5 ACF values of differenced series</span>
        <span class="k">if</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;diff1y_acf5&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">diff1y_acf5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">diff1y_acf_list</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># diff2y_acf1: first ACF value of the twice-differenced series</span>
        <span class="k">if</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;diff2y_acf1&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">diff2y_acf1</span> <span class="o">=</span> <span class="n">diff2y_acf_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># diff2y_acf5: sum of squares of first 5 ACF values of twice-differenced series</span>
        <span class="k">if</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;diff2y_acf5&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">diff2y_acf5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">diff2y_acf_list</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Autocorrelation coefficient at the first seasonal lag.</span>
        <span class="k">if</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;seas_acf1&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">seas_acf1</span> <span class="o">=</span> <span class="n">y_acf_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">y_acf1</span><span class="p">,</span>
            <span class="n">y_acf5</span><span class="p">,</span>
            <span class="n">diff1y_acf1</span><span class="p">,</span>
            <span class="n">diff1y_acf5</span><span class="p">,</span>
            <span class="n">diff2y_acf1</span><span class="p">,</span>
            <span class="n">diff2y_acf5</span><span class="p">,</span>
            <span class="n">seas_acf1</span><span class="p">,</span>
        <span class="p">)</span></div>

    <span class="c1"># PACF features</span>
<div class="viewcode-block" id="TsFeatures.get_pacf_features"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_pacf_features">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">forceobj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_pacf_features</span><span class="p">(</span>
        <span class="n">extra_args</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">],</span>
        <span class="n">default_status</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span>
        <span class="n">y_pacf_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">diff1y_pacf_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
        <span class="n">diff2y_pacf_list</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">float</span><span class="p">],</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Aggregating extracted PACF features from get_acfpacf_features function.</span>

<span class="sd">        Args:</span>
<span class="sd">            extra_args: A dictionary containing information for disabling calculation</span>
<span class="sd">                of a certain feature. Default value is None, i.e. no feature is disabled.</span>
<span class="sd">            default_status: Default status of the switch for calculate the features or not.</span>
<span class="sd">                Default value is True.</span>
<span class="sd">            y_pacf_list: List of PACF values acquired from original time series.</span>
<span class="sd">            diff1y_pacf_list: List of PACF values acquired from differenced time series.</span>
<span class="sd">            diff2y_pacf_list: List of PACF values acquired from twice differenced time series.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Partial auto-correlation function (PACF) features.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="p">(</span>
            <span class="n">y_pacf5</span><span class="p">,</span>
            <span class="n">diff1y_pacf5</span><span class="p">,</span>
            <span class="n">diff2y_pacf5</span><span class="p">,</span>
            <span class="n">seas_pacf1</span><span class="p">,</span>
        <span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>

        <span class="c1"># y_pacf5: sum of squares of first 5 PACF values of original series</span>
        <span class="k">if</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;y_pacf5&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">y_pacf5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">y_pacf_list</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># diff1y_pacf5: sum of squares of first 5 PACF values of differenced series</span>
        <span class="k">if</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;diff1y_pacf5&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">diff1y_pacf5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">diff1y_pacf_list</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># diff2y_pacf5: sum of squares of first 5 PACF values of twice-differenced series</span>
        <span class="k">if</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;diff2y_pacf5&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">diff2y_pacf5</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">diff2y_pacf_list</span><span class="p">)[:</span><span class="mi">5</span><span class="p">]</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

        <span class="c1"># Patial Autocorrelation coefficient at the first seasonal lag.</span>
        <span class="k">if</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;seas_pacf1&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">seas_pacf1</span> <span class="o">=</span> <span class="n">y_pacf_list</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="k">return</span> <span class="p">(</span>
            <span class="n">y_pacf5</span><span class="p">,</span>
            <span class="n">diff1y_pacf5</span><span class="p">,</span>
            <span class="n">diff2y_pacf5</span><span class="p">,</span>
            <span class="n">seas_pacf1</span><span class="p">,</span>
        <span class="p">)</span></div>

<div class="viewcode-block" id="TsFeatures.get_acfpacf_features"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_acfpacf_features">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">forceobj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_acfpacf_features</span><span class="p">(</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">acfpacf_lag</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>
        <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
        <span class="n">extra_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate ACF and PACF based features. Calculate seasonal ACF, PACF based features</span>
<span class="sd">        Reference: https://stackoverflow.com/questions/36038927/whats-the-difference-between-pandas-acf-and-statsmodel-acf</span>
<span class="sd">        R code: https://cran.r-project.org/web/packages/tsfeatures/vignettes/tsfeatures.html</span>
<span class="sd">        Paper: Meta-learning how to forecast time series</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>
<span class="sd">            acfpacf_lag: int; Largest lag number for returning ACF/PACF features via statsmodels.</span>
<span class="sd">                Default value is 6.</span>
<span class="sd">            period: int; Seasonal period. Default value is 7.</span>
<span class="sd">            extra_args: A dictionary containing information for disabling calculation</span>
<span class="sd">                of a certain feature. Default value is None, i.e. no feature is disabled.</span>
<span class="sd">            default_status: Default status of the switch for calculate the features or not.</span>
<span class="sd">                Default value is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Aggregated ACF, PACF features.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">acfpacf_features</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;y_acf1&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;y_acf5&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;diff1y_acf1&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;diff1y_acf5&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;diff2y_acf1&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;diff2y_acf5&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;y_pacf5&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;diff1y_pacf5&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;diff2y_pacf5&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;seas_acf1&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;seas_pacf1&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">period</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;Length is shorter than period, or constant time series! Unable to calculate acf/pacf features!&quot;</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">acfpacf_features</span>

        <span class="n">nlag</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">acfpacf_lag</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

        <span class="n">diff1x</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))]</span>
        <span class="n">diff2x</span> <span class="o">=</span> <span class="p">[</span><span class="n">diff1x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">diff1x</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">diff1x</span><span class="p">))]</span>

        <span class="n">y_acf_list</span> <span class="o">=</span> <span class="n">acf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">unbiased</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fft</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="n">period</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">diff1y_acf_list</span> <span class="o">=</span> <span class="n">acf</span><span class="p">(</span><span class="n">diff1x</span><span class="p">,</span> <span class="n">unbiased</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fft</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="n">nlag</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">diff2y_acf_list</span> <span class="o">=</span> <span class="n">acf</span><span class="p">(</span><span class="n">diff2x</span><span class="p">,</span> <span class="n">unbiased</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fft</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="n">nlag</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="n">y_pacf_list</span> <span class="o">=</span> <span class="n">pacf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="n">period</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">diff1y_pacf_list</span> <span class="o">=</span> <span class="n">pacf</span><span class="p">(</span><span class="n">diff1x</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="n">nlag</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="n">diff2y_pacf_list</span> <span class="o">=</span> <span class="n">pacf</span><span class="p">(</span><span class="n">diff2x</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="n">nlag</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># getting ACF features</span>
        <span class="p">(</span>
            <span class="n">acfpacf_features</span><span class="p">[</span><span class="s2">&quot;y_acf1&quot;</span><span class="p">],</span>
            <span class="n">acfpacf_features</span><span class="p">[</span><span class="s2">&quot;y_acf5&quot;</span><span class="p">],</span>
            <span class="n">acfpacf_features</span><span class="p">[</span><span class="s2">&quot;diff1y_acf1&quot;</span><span class="p">],</span>
            <span class="n">acfpacf_features</span><span class="p">[</span><span class="s2">&quot;diff1y_acf5&quot;</span><span class="p">],</span>
            <span class="n">acfpacf_features</span><span class="p">[</span><span class="s2">&quot;diff2y_acf1&quot;</span><span class="p">],</span>
            <span class="n">acfpacf_features</span><span class="p">[</span><span class="s2">&quot;diff2y_acf5&quot;</span><span class="p">],</span>
            <span class="n">acfpacf_features</span><span class="p">[</span><span class="s2">&quot;seas_acf1&quot;</span><span class="p">],</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">TsFeatures</span><span class="o">.</span><span class="n">get_acf_features</span><span class="p">(</span>
            <span class="n">extra_args</span><span class="p">,</span>
            <span class="n">default_status</span><span class="p">,</span>
            <span class="n">y_acf_list</span><span class="p">,</span>
            <span class="n">diff1y_acf_list</span><span class="p">,</span>
            <span class="n">diff2y_acf_list</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># getting PACF features</span>
        <span class="p">(</span>
            <span class="n">acfpacf_features</span><span class="p">[</span><span class="s2">&quot;y_pacf5&quot;</span><span class="p">],</span>
            <span class="n">acfpacf_features</span><span class="p">[</span><span class="s2">&quot;diff1y_pacf5&quot;</span><span class="p">],</span>
            <span class="n">acfpacf_features</span><span class="p">[</span><span class="s2">&quot;diff2y_pacf5&quot;</span><span class="p">],</span>
            <span class="n">acfpacf_features</span><span class="p">[</span><span class="s2">&quot;seas_pacf1&quot;</span><span class="p">],</span>
        <span class="p">)</span> <span class="o">=</span> <span class="n">TsFeatures</span><span class="o">.</span><span class="n">get_pacf_features</span><span class="p">(</span>
            <span class="n">extra_args</span><span class="p">,</span>
            <span class="n">default_status</span><span class="p">,</span>
            <span class="n">y_pacf_list</span><span class="p">,</span>
            <span class="n">diff1y_pacf_list</span><span class="p">,</span>
            <span class="n">diff2y_pacf_list</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">acfpacf_features</span></div>

    <span class="c1"># standard deviation of the first derivative</span>
<div class="viewcode-block" id="TsFeatures.get_std1st_der"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_std1st_der">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">forceobj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_std1st_der</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculating std1st_der: the standard deviation of the first derivative of the time series.</span>
<span class="sd">        Reference: https://cran.r-project.org/web/packages/tsfeatures/vignettes/tsfeatures.html</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The standard deviation of the first derivative of the time series.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">std1st_der</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">std1st_der</span></div>

    <span class="c1"># crossing points</span>
<div class="viewcode-block" id="TsFeatures.get_crossing_points"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_crossing_points">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_crossing_points</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculating crossing points: the number of times a time series crosses the median line.</span>
<span class="sd">        Reference: https://cran.r-project.org/web/packages/tsfeatures/vignettes/tsfeatures.html</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The number of times a time series crosses the median line.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">median</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">cp</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">median</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">median</span> <span class="o">&gt;</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                <span class="n">cp</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">cp</span></div>

    <span class="c1"># binarize mean</span>
<div class="viewcode-block" id="TsFeatures.get_binarize_mean"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_binarize_mean">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_binarize_mean</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts time series array into a binarized version.</span>
<span class="sd">        Time-series values above its mean are given 1, and those below the mean are 0.</span>
<span class="sd">        Return the average value of the binarized vector.</span>
<span class="sd">        Reference: https://cran.r-project.org/web/packages/tsfeatures/vignettes/tsfeatures.html</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The binarized version of time series array.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">asarray</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x</span><span class="p">))</span></div>

    <span class="c1"># KPSS unit root test</span>
<div class="viewcode-block" id="TsFeatures.get_unitroot_kpss"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_unitroot_kpss">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">forceobj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_unitroot_kpss</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Getting a test statistic based on KPSS test.</span>
<span class="sd">        Test a null hypothesis that an observable time series is stationary around a deterministic trend.</span>
<span class="sd">        A vector comprising the statistic for the KPSS unit root test with linear trend and lag one</span>
<span class="sd">        Wiki: https://en.wikipedia.org/wiki/KPSS_test</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Test statistics acquired using KPSS test.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">kpss</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">regression</span><span class="o">=</span><span class="s2">&quot;ct&quot;</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span></div>

    <span class="c1"># heterogeneity</span>
<div class="viewcode-block" id="TsFeatures.get_het_arch"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_het_arch">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">forceobj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_het_arch</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        reference: https://www.statsmodels.org/dev/generated/statsmodels.stats.diagnostic.het_arch.html</span>
<span class="sd">        Engleâ€™s Test for Autoregressive Conditional Heteroscedasticity (ARCH)</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Lagrange multiplier test statistic</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="n">het_arch</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="nb">min</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">//</span> <span class="mi">5</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span></div>

    <span class="c1"># histogram mode</span>
<div class="viewcode-block" id="TsFeatures.get_histogram_mode"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_histogram_mode">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_histogram_mode</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">nbins</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Measures the mode of the data vector using histograms with a given number of bins.</span>
<span class="sd">        Reference: https://cran.r-project.org/web/packages/tsfeatures/vignettes/tsfeatures.html</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>
<span class="sd">            nbins: int; Number of bins to get the histograms. Default value is 10.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Mode of the data vector using histograms.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cnt</span><span class="p">,</span> <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">histogram</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="n">nbins</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">val</span><span class="p">[</span><span class="n">cnt</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span></div>

    <span class="c1"># First min/zero AC (2)</span>
<div class="viewcode-block" id="TsFeatures.get_special_ac"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_special_ac">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">forceobj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_special_ac</span><span class="p">(</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">extra_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">default_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Gettting special_ac features.</span>
<span class="sd">        firstmin_ac: the time of first minimum in the autocorrelation function</span>
<span class="sd">        firstzero_ac: the time of first zero crossing the autocorrelation function.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>
<span class="sd">            extra_args: A dictionary containing information for disabling calculation</span>
<span class="sd">                of a certain feature. Default value is None, i.e. no feature is disabled.</span>
<span class="sd">            default_status: Default status of the switch for calculate the features or not.</span>
<span class="sd">                Default value is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Special autocorrelation features described above.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># First min AC</span>
        <span class="n">special_ac_features</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;firstmin_ac&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;firstzero_ac&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>
        <span class="n">AC</span> <span class="o">=</span> <span class="n">acf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">unbiased</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fft</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nlags</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;firstmin_ac&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">AC</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">AC</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">AC</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>
            <span class="n">special_ac_features</span><span class="p">[</span><span class="s2">&quot;firstmin_ac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="c1"># First zero AC</span>
        <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;firstzero_ac&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">j</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">AC</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">AC</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="o">&gt;</span> <span class="n">AC</span><span class="p">[</span><span class="n">j</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]:</span>
                    <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">special_ac_features</span><span class="p">[</span><span class="s2">&quot;firstzero_ac&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">j</span> <span class="o">+</span> <span class="mi">2</span>
        <span class="k">return</span> <span class="n">special_ac_features</span></div>

    <span class="c1"># Linearity</span>
<div class="viewcode-block" id="TsFeatures.get_linearity"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_linearity">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">forceobj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">get_linearity</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Getting linearity feature: R square from a fitted linear regression.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>

<span class="sd">        Returns:</span>
<span class="sd">            R square from a fitted linear regression.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">r_value</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">linregress</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)),</span> <span class="n">x</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">r_value</span> <span class="o">**</span> <span class="mi">2</span></div>

    <span class="c1"># Holt Parameters (2)</span>
<div class="viewcode-block" id="TsFeatures.get_holt_params"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_holt_params">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_holt_params</span><span class="p">(</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">extra_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">default_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimates the smoothing parameter for the level-alpha and the smoothing parameter</span>
<span class="sd">        for the trend-beta of Holtâ€™s linear trend method.</span>
<span class="sd">        &#39;alpha&#39;: Level parameter of the Holt model.</span>
<span class="sd">        &#39;beta&#39;: Trend parameter of the Hold model.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>
<span class="sd">            extra_args: A dictionary containing information for disabling calculation</span>
<span class="sd">                of a certain feature. Default value is None, i.e. no feature is disabled.</span>
<span class="sd">            default_status: Default status of the switch for calculate the features or not.</span>
<span class="sd">                Default value is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Level and trend parameter of a fitted Holt model.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">holt_params_features</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;holt_alpha&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;holt_beta&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">ExponentialSmoothing</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">trend</span><span class="o">=</span><span class="s2">&quot;add&quot;</span><span class="p">,</span> <span class="n">seasonal</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;holt_alpha&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">holt_params_features</span><span class="p">[</span><span class="s2">&quot;holt_alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;smoothing_level&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;holt_beta&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">statsmodels_ver</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;([0-9]+</span><span class="se">\\</span><span class="s1">.[0-9]+)</span><span class="se">\\</span><span class="s1">..*&#39;</span><span class="p">,</span> <span class="n">statsmodels</span><span class="o">.</span><span class="n">__version__</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">statsmodels_ver</span> <span class="o">&lt;</span> <span class="mf">0.12</span><span class="p">:</span>
                    <span class="n">holt_params_features</span><span class="p">[</span><span class="s2">&quot;holt_beta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;smoothing_slope&quot;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">statsmodels_ver</span> <span class="o">&gt;=</span> <span class="mf">0.12</span><span class="p">:</span>
                    <span class="n">holt_params_features</span><span class="p">[</span><span class="s2">&quot;holt_beta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;smoothing_trend&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">holt_params_features</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">holt_params_features</span></div>

    <span class="c1"># Holt Winterâ€™s Parameters (3)</span>
<div class="viewcode-block" id="TsFeatures.get_hw_params"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_hw_params">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_hw_params</span><span class="p">(</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">period</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">7</span><span class="p">,</span>
        <span class="n">extra_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimates the smoothing parameter for the level-alpha, trend-beta of HWâ€™s linear trend,</span>
<span class="sd">        and additive seasonal trend-gamma.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>
<span class="sd">            period: int; Seaonal period for fitting exponential smoothing model. Default</span>
<span class="sd">                value is 7.</span>
<span class="sd">            extra_args: A dictionary containing information for disabling calculation</span>
<span class="sd">                of a certain feature. Default value is None, i.e. no feature is disabled.</span>
<span class="sd">            default_status: Default status of the switch for calculate the features or not.</span>
<span class="sd">                Default value is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Level, trend and seasonal parameter of a fitted Holt-Winter&#39;s model.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">hw_params_features</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;hw_alpha&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;hw_beta&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="s2">&quot;hw_gamma&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># addressing issue of use_boxcox arg in different versions of statsmodels</span>
            <span class="n">statsmodels_ver</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="s1">&#39;([0-9]+</span><span class="se">\\</span><span class="s1">.[0-9]+)</span><span class="se">\\</span><span class="s1">..*&#39;</span><span class="p">,</span> <span class="n">statsmodels</span><span class="o">.</span><span class="n">__version__</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">_args_</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;seasonal_periods&quot;</span><span class="p">:</span> <span class="n">period</span><span class="p">,</span>
                <span class="s2">&quot;trend&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span>
                <span class="s2">&quot;seasonal&quot;</span><span class="p">:</span> <span class="s2">&quot;add&quot;</span><span class="p">,</span>
            <span class="p">}</span>
            <span class="c1"># performing version check on statsmodels</span>
            <span class="k">if</span> <span class="n">statsmodels_ver</span> <span class="o">&gt;=</span> <span class="mf">0.12</span><span class="p">:</span>
                <span class="n">_args_</span><span class="p">[</span><span class="s2">&quot;use_boxcox&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="n">_args_</span><span class="p">[</span><span class="s2">&quot;initialization_method&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;estimated&#39;</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">ExponentialSmoothing</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">_args_</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">statsmodels_ver</span> <span class="o">&lt;</span> <span class="mf">0.12</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">ExponentialSmoothing</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="o">**</span><span class="n">_args_</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">use_boxcox</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hw_alpha&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">hw_params_features</span><span class="p">[</span><span class="s2">&quot;hw_alpha&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;smoothing_level&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hw_beta&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">statsmodels_ver</span> <span class="o">&lt;</span> <span class="mf">0.12</span><span class="p">:</span>
                    <span class="n">hw_params_features</span><span class="p">[</span><span class="s2">&quot;hw_beta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;smoothing_slope&quot;</span><span class="p">]</span>
                <span class="k">elif</span> <span class="n">statsmodels_ver</span> <span class="o">&gt;=</span> <span class="mf">0.12</span><span class="p">:</span>
                    <span class="n">hw_params_features</span><span class="p">[</span><span class="s2">&quot;hw_beta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;smoothing_trend&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;hw_gamma&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">hw_params_features</span><span class="p">[</span><span class="s2">&quot;hw_gamma&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="s2">&quot;smoothing_seasonal&quot;</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">hw_params_features</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">hw_params_features</span></div>

    <span class="c1"># CUSUM Detection Outputs (8)</span>
<div class="viewcode-block" id="TsFeatures.get_cusum_detector"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_cusum_detector">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_cusum_detector</span><span class="p">(</span>
        <span class="n">ts</span><span class="p">:</span> <span class="n">TimeSeriesData</span><span class="p">,</span> <span class="n">extra_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">default_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the Kats CUSUM Detector on the Time Series, extract features from the outputs of the detection.</span>

<span class="sd">        Args:</span>
<span class="sd">            ts: The univariate time series array in the form of Kats TimeSeriesData object.</span>
<span class="sd">            extra_args: A dictionary containing information for disabling calculation</span>
<span class="sd">                of a certain feature. Default value is None, i.e. no feature is disabled.</span>
<span class="sd">            default_status: Default status of the switch for calculate the features or not.</span>
<span class="sd">                Default value is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Outputs of the CUSUM Detector, which include (1) Number of changepoints, either 1</span>
<span class="sd">            or 0, (2) Confidence of the changepoint detected, 0 if not changepoint, (3) index,</span>
<span class="sd">            or position of the changepoint detected within the time series, (4) delta of the</span>
<span class="sd">            mean levels before and after the changepoint, (5) log-likelihood ratio of changepoint,</span>
<span class="sd">            (6) Boolean - whether regression is detected by CUSUM, (7) Boolean - whether</span>
<span class="sd">            changepoint is stable, (8) p-value of changepoint.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">cusum_detector_features</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;cusum_num&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;cusum_conf&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;cusum_cp_index&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;cusum_delta&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;cusum_llr&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;cusum_regression_detected&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;cusum_stable_changepoint&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;cusum_p_value&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cusum</span> <span class="o">=</span> <span class="n">cusum_detection</span><span class="o">.</span><span class="n">CUSUMDetector</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
            <span class="n">cusum_cp</span> <span class="o">=</span> <span class="n">cusum</span><span class="o">.</span><span class="n">detector</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cusum_num&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">cusum_detector_features</span><span class="p">[</span><span class="s2">&quot;cusum_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cusum_cp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cusum_conf&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">cusum_detector_features</span><span class="p">[</span><span class="s2">&quot;cusum_conf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cusum_cp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">cusum_cp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">confidence</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cusum_cp_index&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">cusum_detector_features</span><span class="p">[</span><span class="s2">&quot;cusum_cp_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cusum_cp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">cusum_cp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_cp_index</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cusum_delta&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">cusum_detector_features</span><span class="p">[</span><span class="s2">&quot;cusum_delta&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cusum_cp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">cusum_cp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_delta</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cusum_llr&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">cusum_detector_features</span><span class="p">[</span><span class="s2">&quot;cusum_llr&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cusum_cp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">cusum_cp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_llr</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cusum_regression_detected&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">cusum_detector_features</span><span class="p">[</span><span class="s2">&quot;cusum_regression_detected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="kc">False</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cusum_cp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">cusum_cp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_regression_detected</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cusum_stable_changepoint&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">cusum_detector_features</span><span class="p">[</span><span class="s2">&quot;cusum_stable_changepoint&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="kc">False</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cusum_cp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">cusum_cp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_stable_changepoint</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;cusum_p_value&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">cusum_detector_features</span><span class="p">[</span><span class="s2">&quot;cusum_p_value&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">0</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cusum_cp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">else</span> <span class="n">cusum_cp</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_p_value</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">cusum_detector_features</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">cusum_detector_features</span></div>

    <span class="c1"># Robust Stat Detection Outputs (2)</span>
<div class="viewcode-block" id="TsFeatures.get_robust_stat_detector"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_robust_stat_detector">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_robust_stat_detector</span><span class="p">(</span>
        <span class="n">ts</span><span class="p">:</span> <span class="n">TimeSeriesData</span><span class="p">,</span> <span class="n">extra_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">default_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the Kats Robust Stat Detector on the Time Series, extract features from the outputs of the detection.</span>

<span class="sd">        Args:</span>
<span class="sd">            ts: The univariate time series array in the form of Kats TimeSeriesData object.</span>
<span class="sd">            extra_args: A dictionary containing information for disabling calculation</span>
<span class="sd">                of a certain feature. Default value is None, i.e. no feature is disabled.</span>
<span class="sd">            default_status: Default status of the switch for calculate the features or not.</span>
<span class="sd">                Default value is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (1) Number changepoints detected by the Robust Stat Detector, and (2) Mean of</span>
<span class="sd">            the Metric values from the Robust Stat Detector.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">robust_stat_detector_features</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;robust_num&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;robust_metric_mean&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">robust</span> <span class="o">=</span> <span class="n">robust_stat_detection</span><span class="o">.</span><span class="n">RobustStatDetector</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
            <span class="n">robust_cp</span> <span class="o">=</span> <span class="n">robust</span><span class="o">.</span><span class="n">detector</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;robust_num&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">robust_stat_detector_features</span><span class="p">[</span><span class="s2">&quot;robust_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">robust_cp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;robust_metric_mean&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">robust_stat_detector_features</span><span class="p">[</span><span class="s2">&quot;robust_metric_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">0</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">robust_cp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">cp</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">_metric</span> <span class="k">for</span> <span class="n">cp</span> <span class="ow">in</span> <span class="n">robust_cp</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">robust_cp</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">robust_stat_detector_features</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">robust_stat_detector_features</span></div>

    <span class="c1"># BOCP Detection Outputs (3)</span>
<div class="viewcode-block" id="TsFeatures.get_bocp_detector"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_bocp_detector">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_bocp_detector</span><span class="p">(</span>
        <span class="n">ts</span><span class="p">:</span> <span class="n">TimeSeriesData</span><span class="p">,</span> <span class="n">extra_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">default_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the Kats BOCP Detector on the Time Series, extract features from the outputs of the detection.</span>

<span class="sd">        Args:</span>
<span class="sd">            ts: The univariate time series array in the form of Kats TimeSeriesData object.</span>
<span class="sd">            extra_args: A dictionary containing information for disabling calculation</span>
<span class="sd">                of a certain feature. Default value is None, i.e. no feature is disabled.</span>
<span class="sd">            default_status: Default status of the switch for calculate the features or not.</span>
<span class="sd">                Default value is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (tuple): tuple containing:</span>

<span class="sd">                Number of changepoints detected by BOCP Detector</span>
<span class="sd">                Max value of the confidence of the changepoints detected</span>
<span class="sd">                Mean value of the confidence of the changepoints detected.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">bocp_detector_features</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;bocp_num&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;bocp_conf_max&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;bocp_conf_mean&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">bocp</span> <span class="o">=</span> <span class="n">bocpd</span><span class="o">.</span><span class="n">BOCPDetector</span><span class="p">(</span><span class="n">ts</span><span class="p">)</span>
            <span class="n">bocp_cp</span> <span class="o">=</span> <span class="n">bocp</span><span class="o">.</span><span class="n">detector</span><span class="p">(</span><span class="n">choose_priors</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bocp_num&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">bocp_detector_features</span><span class="p">[</span><span class="s2">&quot;bocp_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bocp_cp</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bocp_conf_max&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">bocp_detector_features</span><span class="p">[</span><span class="s2">&quot;bocp_conf_max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">0</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bocp_cp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">confidence</span> <span class="k">for</span> <span class="n">cp</span> <span class="ow">in</span> <span class="n">bocp_cp</span><span class="p">])</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;bocp_conf_mean&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">bocp_detector_features</span><span class="p">[</span><span class="s2">&quot;bocp_conf_mean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">0</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bocp_cp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">cp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">confidence</span> <span class="k">for</span> <span class="n">cp</span> <span class="ow">in</span> <span class="n">bocp_cp</span><span class="p">])</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">bocp_cp</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">bocp_detector_features</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">bocp_detector_features</span></div>

    <span class="c1"># Outlier Detection Outputs (1)</span>
<div class="viewcode-block" id="TsFeatures.get_outlier_detector"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_outlier_detector">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_outlier_detector</span><span class="p">(</span>
        <span class="n">ts</span><span class="p">:</span> <span class="n">TimeSeriesData</span><span class="p">,</span>
        <span class="n">decomp</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;additive&quot;</span><span class="p">,</span>
        <span class="n">iqr_mult</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">3.0</span><span class="p">,</span>
        <span class="n">extra_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the Kats Outlier Detector on the Time Series, extract features from the outputs of the detection.</span>

<span class="sd">        Args:</span>
<span class="sd">            ts: The univariate time series array in the form of Kats TimeSeriesData object.</span>
<span class="sd">            decomp: str; Additive or Multiplicative mode for performing outlier detection using</span>
<span class="sd">                OutlierDetector. Default value is &#39;additive&#39;.</span>
<span class="sd">            iqr_mult: float; IQR range for determining outliers through</span>
<span class="sd">                OutlierDetector. Default value is 3.0.</span>
<span class="sd">            extra_args: A dictionary containing information for disabling calculation</span>
<span class="sd">                of a certain feature. Default value is None, i.e. no feature is disabled.</span>
<span class="sd">            default_status: Default status of the switch for calculate the features or not.</span>
<span class="sd">                Default value is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Number of outliers by the Outlier Detector.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">outlier_detector_features</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;outlier_num&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">odetector</span> <span class="o">=</span> <span class="n">outlier</span><span class="o">.</span><span class="n">OutlierDetector</span><span class="p">(</span><span class="n">ts</span><span class="p">,</span> <span class="n">decomp</span><span class="o">=</span><span class="n">decomp</span><span class="p">,</span> <span class="n">iqr_mult</span><span class="o">=</span><span class="n">iqr_mult</span><span class="p">)</span>
            <span class="n">odetector</span><span class="o">.</span><span class="n">detector</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;outlier_num&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="c1"># pyre-fixme[16]: `OutlierDetector` has no attribute `outliers`.</span>
                <span class="n">outlier_detector_features</span><span class="p">[</span><span class="s2">&quot;outlier_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">odetector</span><span class="o">.</span><span class="n">outliers</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">return</span> <span class="n">outlier_detector_features</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">outlier_detector_features</span></div>

    <span class="c1"># Trend Detection Outputs (3)</span>
<div class="viewcode-block" id="TsFeatures.get_trend_detector"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_trend_detector">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_trend_detector</span><span class="p">(</span>
        <span class="n">ts</span><span class="p">:</span> <span class="n">TimeSeriesData</span><span class="p">,</span>
        <span class="n">threshold</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.8</span><span class="p">,</span>
        <span class="n">extra_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the Kats Trend Detector on the Time Series, extract features from the outputs of the detection.</span>

<span class="sd">        Args:</span>
<span class="sd">            ts: The univariate time series array in the form of Kats TimeSeriesData object.</span>
<span class="sd">            threshold: float; threshold for trend intensity; higher threshold gives trend</span>
<span class="sd">                with high intensity (0.8 by default).  If we only want to use the p-value</span>
<span class="sd">                to determine changepoints, set threshold = 0.</span>
<span class="sd">            extra_args: A dictionary containing information for disabling calculation</span>
<span class="sd">                of a certain feature. Default value is None, i.e. no feature is disabled.</span>
<span class="sd">            default_status: Default status of the switch for calculate the features or not.</span>
<span class="sd">                Default value is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            (1) Number of trends detected by the Kats Trend Detector, (2) Number of increasing</span>
<span class="sd">            trends, (3) Mean of the abolute values of Taus of the trends detected.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">trend_detector_features</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;trend_num&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;trend_num_increasing&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;trend_avg_abs_tau&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">tdetector</span> <span class="o">=</span> <span class="n">trend_mk</span><span class="o">.</span><span class="n">MKDetector</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">ts</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="n">threshold</span><span class="p">)</span>
            <span class="n">tdetected_time_points</span> <span class="o">=</span> <span class="n">tdetector</span><span class="o">.</span><span class="n">detector</span><span class="p">(</span><span class="n">direction</span><span class="o">=</span><span class="s2">&quot;both&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;trend_num&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">trend_detector_features</span><span class="p">[</span><span class="s2">&quot;trend_num&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tdetected_time_points</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;trend_num_increasing&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">trend_detector_features</span><span class="p">[</span><span class="s2">&quot;trend_num_increasing&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="n">p</span>
                        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">tdetected_time_points</span>
                        <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">trend_direction</span> <span class="o">==</span> <span class="s2">&quot;decreasing&quot;</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;trend_avg_abs_tau&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">trend_detector_features</span><span class="p">[</span><span class="s2">&quot;trend_avg_abs_tau&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="mi">0</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tdetected_time_points</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span>
                    <span class="k">else</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="nb">abs</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">Tau</span><span class="p">)</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">tdetected_time_points</span><span class="p">])</span>
                    <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">tdetected_time_points</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">return</span> <span class="n">trend_detector_features</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">trend_detector_features</span></div>

    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_ewma</span><span class="p">(</span>
        <span class="n">arr</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">span</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
        <span class="n">min_periods</span><span class="p">:</span> <span class="nb">int</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Exponentialy weighted moving average specified by a decay ``window``</span>
<span class="sd">        to provide better adjustments for small windows via:</span>
<span class="sd">            y[t] = (x[t] + (1-a)*x[t-1] + (1-a)^2*x[t-2] + ... + (1-a)^n*x[t-n]) /</span>
<span class="sd">                   (1 + (1-a) + (1-a)^2 + ... + (1-a)^n).</span>

<span class="sd">        Args:</span>
<span class="sd">        arr : np.ndarray; A single dimenisional numpy array.</span>
<span class="sd">        span : int; The decay window, or &#39;span&#39;.</span>
<span class="sd">        min_periods: int; Minimum amount of data points we&#39;d like to include in the output.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A np.ndarray. The exponentially weighted moving average of the array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">output_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">output_array</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span>

        <span class="n">arr</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">arr</span><span class="p">)]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ewma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">span</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">w</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">ewma_old</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">ewma</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ewma_old</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
            <span class="n">w</span> <span class="o">+=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span><span class="o">**</span><span class="n">i</span>
            <span class="n">ewma_old</span> <span class="o">=</span> <span class="n">ewma_old</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
            <span class="n">ewma</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">ewma_old</span> <span class="o">/</span> <span class="n">w</span>

        <span class="n">output_subset</span> <span class="o">=</span> <span class="n">ewma</span><span class="p">[(</span><span class="n">min_periods</span><span class="o">-</span><span class="mi">1</span><span class="p">):]</span>
        <span class="n">output_array</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">output_subset</span><span class="p">):]</span> <span class="o">=</span> <span class="n">output_subset</span>
        <span class="k">return</span> <span class="n">output_array</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@jit</span><span class="p">(</span><span class="n">forceobj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_get_nowcasting_np</span><span class="p">(</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">n_fast</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">n_slow</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">21</span><span class="p">,</span>
        <span class="n">extra_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Internal function for actually performing feature engineering using the same procedure as</span>
<span class="sd">        nowcasting feature_extraction under kats/models.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>
<span class="sd">            window: int; Length of window size for all Nowcasting features. Default value is 5.</span>
<span class="sd">            n_fast: int; length of &quot;fast&quot; or short period exponential moving average in the MACD</span>
<span class="sd">                algorithm in the nowcasting features. Default value is 12.</span>
<span class="sd">            n_slow: int; length of &quot;slow&quot; or long period exponential moving average in the MACD</span>
<span class="sd">                algorithm in the nowcasting features. Default value is 21.</span>
<span class="sd">            extra_args: A dictionary containing information for disabling calculation</span>
<span class="sd">                of a certain feature. Default value is None, i.e. no feature is disabled.</span>
<span class="sd">            default_status: Default status of the switch for calculate the features or not.</span>
<span class="sd">                Default value is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A list containing extracted nowcast features.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># initializing the outputs</span>
        <span class="n">nowcasting_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">7</span><span class="p">)]</span>

        <span class="c1"># ROC: indicating return comparing to step n back.</span>
        <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nowcast_roc&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">x</span><span class="p">[(</span><span class="n">window</span><span class="o">-</span><span class="mi">1</span><span class="p">):]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="p">(</span><span class="n">window</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="p">(</span><span class="n">window</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
            <span class="n">arr</span> <span class="o">=</span> <span class="n">M</span> <span class="o">/</span> <span class="n">N</span>
            <span class="n">nowcasting_features</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">posinf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># MOM: indicating momentum: difference of current value and n steps back.</span>
        <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nowcast_mom&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">M</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">window</span><span class="p">:]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="n">window</span><span class="p">]</span>
            <span class="n">nowcasting_features</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">M</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">posinf</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># MA: indicating moving average in the past n steps.</span>
        <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nowcast_ma&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">float</span><span class="p">)</span>
            <span class="n">ret</span><span class="p">[</span><span class="n">window</span><span class="p">:]</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="n">window</span><span class="p">:]</span> <span class="o">-</span> <span class="n">ret</span><span class="p">[:</span><span class="o">-</span><span class="n">window</span><span class="p">]</span>
            <span class="n">ma</span> <span class="o">=</span> <span class="n">ret</span><span class="p">[</span><span class="n">window</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">/</span> <span class="n">window</span>
            <span class="n">nowcasting_features</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">ma</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">posinf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># LAG: indicating lagged value at the past n steps.</span>
        <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nowcast_lag&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">N</span> <span class="o">=</span> <span class="n">x</span><span class="p">[:</span><span class="o">-</span><span class="n">window</span><span class="p">]</span>
            <span class="n">nowcasting_features</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">N</span><span class="p">,</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">posinf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="c1"># MACD: https://www.investopedia.com/terms/m/macd.asp.</span>
        <span class="n">ema_fast</span> <span class="o">=</span> <span class="n">TsFeatures</span><span class="o">.</span><span class="n">_ewma</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n_fast</span><span class="p">,</span> <span class="n">n_slow</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">ema_slow</span> <span class="o">=</span> <span class="n">TsFeatures</span><span class="o">.</span><span class="n">_ewma</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n_slow</span><span class="p">,</span> <span class="n">n_slow</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">MACD</span> <span class="o">=</span> <span class="n">ema_fast</span> <span class="o">-</span> <span class="n">ema_slow</span>
        <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nowcast_macd&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">nowcasting_features</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">MACD</span><span class="p">),</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">posinf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="n">MACDsign</span> <span class="o">=</span> <span class="n">TsFeatures</span><span class="o">.</span><span class="n">_ewma</span><span class="p">(</span><span class="n">MACD</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nowcast_macdsign&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">nowcasting_features</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">MACDsign</span><span class="p">),</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">posinf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="n">MACDdiff</span> <span class="o">=</span> <span class="n">MACD</span> <span class="o">-</span> <span class="n">MACDsign</span>
        <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nowcast_macddiff&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
            <span class="n">nowcasting_features</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">MACDdiff</span><span class="p">),</span> <span class="n">nan</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">posinf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">neginf</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">nowcasting_features</span>

    <span class="c1"># Nowcasting features (7)</span>
<div class="viewcode-block" id="TsFeatures.get_nowcasting"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_nowcasting">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_nowcasting</span><span class="p">(</span>
        <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
        <span class="n">window</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span>
        <span class="n">n_fast</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>
        <span class="n">n_slow</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">21</span><span class="p">,</span>
        <span class="n">extra_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">default_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the Kats Nowcasting transformer on the Time Series, extract aggregated features from the outputs of the transformation.</span>

<span class="sd">        Args:</span>
<span class="sd">            x: The univariate time series array in the form of 1d numpy array.</span>
<span class="sd">            window: int; Length of window size for all Nowcasting features. Default value is 5.</span>
<span class="sd">            n_fast: int; length of &quot;fast&quot; or short period exponential moving average in the MACD</span>
<span class="sd">                algorithm in the nowcasting features. Default value is 12.</span>
<span class="sd">            n_slow: int; length of &quot;slow&quot; or long period exponential moving average in the MACD</span>
<span class="sd">                algorithm in the nowcasting features. Default value is 21.</span>
<span class="sd">            extra_args: A dictionary containing information for disabling calculation</span>
<span class="sd">                of a certain feature. Default value is None, i.e. no feature is disabled.</span>
<span class="sd">            default_status: Default status of the switch for calculate the features or not.</span>
<span class="sd">                Default value is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Mean values of the Kats Nowcasting algorithm time series outputs using the parameters</span>
<span class="sd">            (window, n_fast, n_slow) indicated above. These outputs inclue : (1) Mean of Rate of</span>
<span class="sd">            Change (ROC) time series, (2) Mean of Moving Average (MA) time series,(3) Mean of</span>
<span class="sd">            Momentum (MOM) time series, (4) Mean of LAG time series, (5) Means of MACD, MACDsign,</span>
<span class="sd">            and MACDdiff from Kats Nowcasting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nowcasting_features</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">features</span> <span class="o">=</span> <span class="p">[</span>
            <span class="s2">&quot;nowcast_roc&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nowcast_mom&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nowcast_ma&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nowcast_lag&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nowcast_macd&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nowcast_macdsign&quot;</span><span class="p">,</span>
            <span class="s2">&quot;nowcast_macddiff&quot;</span><span class="p">,</span>
        <span class="p">]</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">features</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">nowcasting_features</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">_features</span> <span class="o">=</span> <span class="n">TsFeatures</span><span class="o">.</span><span class="n">_get_nowcasting_np</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">window</span><span class="p">,</span> <span class="n">n_fast</span><span class="p">,</span> <span class="n">n_slow</span><span class="p">,</span> <span class="n">extra_args</span><span class="p">,</span> <span class="n">default_status</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">feature</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">features</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">feature</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                    <span class="n">nowcasting_features</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">_features</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">nowcasting_features</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">nowcasting_features</span></div>

    <span class="c1"># seasonality features (4)</span>
<div class="viewcode-block" id="TsFeatures.get_seasonalities"><a class="viewcode-back" href="../../../kats.tsfeatures.tsfeatures.html#kats.tsfeatures.tsfeatures.TsFeatures.get_seasonalities">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">get_seasonalities</span><span class="p">(</span>
        <span class="n">ts</span><span class="p">:</span> <span class="n">TimeSeriesData</span><span class="p">,</span> <span class="n">extra_args</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">bool</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">default_status</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Run the Kats seaonality detectors to get the estimated seasonal period, then extract trend,</span>
<span class="sd">        seasonality and residual magnitudes.</span>

<span class="sd">        Args:</span>
<span class="sd">            ts: The univariate time series array in the form of Kats TimeSeriesData object.</span>
<span class="sd">            extra_args: A dictionary containing information for disabling calculation</span>
<span class="sd">                of a certain feature. Default value is None, i.e. no feature is disabled.</span>
<span class="sd">            default_status: Default status of the switch for calculate the features or not.</span>
<span class="sd">                Default value is True.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Returns the detected seasonality period.</span>
<span class="sd">            Slope acquired via fitting simple linear regression model on the trend component</span>
<span class="sd">            as trend magnitude.</span>
<span class="sd">            Difference between the 95 percentile and 5 percentile of the seasonal component</span>
<span class="sd">            as the seasonality magnitude.</span>
<span class="sd">            Standard deviation of the residual component.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">seasonality_features</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;seasonal_period&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;trend_mag&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;seasonality_mag&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
            <span class="s2">&quot;residual_std&quot;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># detrending for period estimation</span>
            <span class="n">detrended</span> <span class="o">=</span> <span class="n">TimeSeriesData</span><span class="p">(</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="p">{</span>
                        <span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
                        <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">ts</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">ts</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                    <span class="p">}</span>
                <span class="p">)</span>
            <span class="p">)</span>
            <span class="n">detected</span> <span class="o">=</span> <span class="n">seasonality</span><span class="o">.</span><span class="n">FFTDetector</span><span class="p">(</span><span class="n">detrended</span><span class="p">)</span><span class="o">.</span><span class="n">detector</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">detected</span><span class="p">[</span><span class="s2">&quot;seasonality_presence&quot;</span><span class="p">]:</span>
                <span class="n">_period</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">detected</span><span class="p">[</span><span class="s2">&quot;seasonalities&quot;</span><span class="p">]))</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">detected</span><span class="p">[</span><span class="s2">&quot;seasonality_presence&quot;</span><span class="p">]:</span>
                <span class="n">_period</span> <span class="o">=</span> <span class="mi">7</span>
            <span class="n">res</span> <span class="o">=</span> <span class="n">STL</span><span class="p">(</span><span class="n">ts</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">period</span><span class="o">=</span><span class="n">_period</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;seasonal_period&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">seasonality_features</span><span class="p">[</span><span class="s2">&quot;seasonal_period&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_period</span>

            <span class="c1"># getting seasonality magnitude</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;seasonality_mag&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">seasonality_features</span><span class="p">[</span><span class="s2">&quot;seasonality_mag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">seasonal</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">quantile</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">seasonal</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="c1"># fitting linear regression for trend magnitude</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;trend_mag&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">exog</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">trend</span>
                <span class="n">_series</span> <span class="o">=</span> <span class="n">exog</span> <span class="o">-</span> <span class="n">exog</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">mod</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">_series</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">_series</span><span class="p">)))</span>
                <span class="n">_res</span> <span class="o">=</span> <span class="n">mod</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>
                <span class="c1"># trend magnitude</span>
                <span class="n">seasonality_features</span><span class="p">[</span><span class="s2">&quot;trend_mag&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_res</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># residual standard deviation</span>
            <span class="k">if</span> <span class="n">extra_args</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">extra_args</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;residual_std&quot;</span><span class="p">,</span> <span class="n">default_status</span><span class="p">):</span>
                <span class="n">seasonality_features</span><span class="p">[</span><span class="s2">&quot;residual_std&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">resid</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">seasonality_features</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">seasonality_features</span></div></div>
</pre></div>

          </div>
          
        </div>
      </div>
</div>
<footer class="footer">
    <div class="container">
        <div class="row footer__links">
            <div class="col footer__col">
                <div class="footer__title">Links</div>
                <ul class="footer__items">
                    <li class="footer__item">
                        <a href="https://github.com/facebookresearch/Kats" target="_blank" rel="noopener noreferrer" class="footer__link-item">Kats@GitHub</a>
                    </li>
                </ul>
            </div>
            <div class="col footer__col">
                <div class="footer__title">Legal</div>
                <ul class="footer__items">
                    <li class="footer__item">
                        <a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noreferrer noopener" class="footer__link-item">Privacy</a>
                    </li>
                    <li class="footer__item">
                        <a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noreferrer noopener" class="footer__link-item">Terms</a>
                    </li>
                    <li class="footer__item">
                        <a href="https://opensource.facebook.com/legal/cookie-policy" target="_blank" rel="noreferrer noopener" class="footer__link-item">Cookies</a>
                    </li>
                </ul>
            </div>
        </div>
        <div class="footer__bottom text--center">
            <div class="margin-bottom--sm">
                <img src="https://docusaurus.io/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"/>
                <img src="https://docusaurus.io/img/oss_logo.png" alt="Facebook Open Source Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"/>
            </div>
            <div class="footer__copyright">Copyright Â© 2021 Facebook, Inc.</div>
        </div>
    </div>
</footer>
<!--
</div>
<script src="/Kats/assets/js/runtime~main.9e005abd.js"></script>
<script src="/Kats/assets/js/main.6382ca5e.js"></script>
-->

      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">Kats</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../kats.consts.html">kats.consts module</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kats.detectors.html">kats.detectors package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kats.graphics.html">kats.graphics package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kats.models.html">kats.models package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kats.tsfeatures.html">kats.tsfeatures package</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../kats.utils.html">kats.utils package</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      
      
      
      Powered by <a href="http://sphinx-doc.org/">Sphinx 4.0.2</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>